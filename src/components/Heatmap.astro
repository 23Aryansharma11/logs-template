---
import { heatmapData } from "../constants";
import { userData } from "../site-config";
import { DateTime } from "luxon";

function getPastDates(numDays: number) {
    const today = DateTime.now().startOf("day");
    const days: { date: string; count: number }[] = [];

    for (let i = numDays - 1; i >= 0; i--) {
        const d = today.minus({ days: i }).toISODate();
        days.push({ date: d!, count: heatmapData[d!] ?? 0 });
    }

    return days;
}

const cells = getPastDates(userData.daysInHeatMap);
const totalWeeks = Math.ceil(cells.length / 7);

const weeks = Array.from({ length: totalWeeks }, (_, week) =>
    cells.slice(week * 7, week * 7 + 7),
);

const heatmapWidthRem = `${totalWeeks * 0.9}rem`;
---

<h1
    class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100 mb-4 tracking-tight text-center w-full"
>
    Logging Activity
</h1>

<div class="w-full overflow-x-auto no-scrollbar">
    <div class="mx-auto w-fit px-2">
        <div
            id="heatmap"
            class="flex gap-[3px]"
            style={`min-width: ${heatmapWidthRem};`}
        >
            {
                weeks.map((week) => (
                    <div class="flex flex-col gap-[3px]">
                        {week.map(({ date, count }) => (
                            <div
                                data-date={date}
                                title={`${date} â€” ${count} logs`}
                                class={`btn w-4 h-4 sm:w-5 sm:h-5 rounded-sm transition-colors duration-200 cursor-pointer hover:brightness-110
                                ${
                                    count === 0
                                        ? "bg-gray-200 dark:bg-gray-700"
                                        : count === 1
                                          ? "bg-gray-400 dark:bg-gray-600"
                                          : count === 2
                                            ? "bg-gray-500 dark:bg-gray-500"
                                            : count === 3
                                              ? "bg-gray-600 dark:bg-gray-400"
                                              : "bg-gray-700 dark:bg-gray-300"
                                }`}
                            />
                        ))}
                    </div>
                ))
            }
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const heatmap = document.getElementById("heatmap");

        heatmap?.addEventListener("click", (e) => {
            const target = e.target as HTMLElement;
            if (target?.classList.contains("btn")) {
                const date = target.getAttribute("data-date");
                const el = document.getElementById(`log-${date}`);
                if (el) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    el.classList.add(
                        "ring-1",
                        "ring-gray-400",
                        "dark:ring-gray-100",
                    );
                    setTimeout(() => {
                        el.classList.remove(
                            "ring-1",
                            "ring-gray-400",
                            "dark:ring-gray-100",
                        );
                    }, 1500);
                }
            }
        });
    });
</script>
